import React, { useState, useEffect } from 'react';
import VoiceRecorder from './VoiceRecorder';
import { EXERCISE_LIST, EXERCISE_CATEGORIES, addCustomExercise } from '../data/exerciseTypes.js';
import useIndexedDB from '../hooks/useIndexedDB';

const RecordTab = ({ onRecordSaved, isLoading, setIsLoading, todayRecords = [], allRecords = [] }) => {
  const [inputMode, setInputMode] = useState('voice'); // 'voice' or 'manual'
  const [selectedExercise, setSelectedExercise] = useState(null);
  const [reps, setReps] = useState('');
  const [sets, setSets] = useState('');
  const [editingExercise, setEditingExercise] = useState(null); // ч╖ищЫЖф╕нуБочиочЫоID
  const [editValues, setEditValues] = useState({ reps: '', sets: '' }); // ч╖ищЫЖф╕нуБохАд
  const [customExercises, setCustomExercises] = useState([]); // уВлуВ╣уВ┐уГачиочЫоуГкуВ╣уГИ
  const [showAddExercise, setShowAddExercise] = useState(false); // чиочЫош┐╜хКаUIшбичд║
  const [newExerciseName, setNewExerciseName] = useState(''); // цЦ░чиочЫохРН
  const { saveRecord, saveCustomExercise, getCustomExercises } = useIndexedDB();
  
  // уВлуВ╣уВ┐уГачиочЫоуБошкнуБ┐ш╛╝уБ┐
  useEffect(() => {
    const loadCustomExercises = async () => {
      try {
        const exercises = await getCustomExercises();
        setCustomExercises(exercises);
      } catch (error) {
        console.error('уВлуВ╣уВ┐уГачиочЫошкнуБ┐ш╛╝уБ┐уВиуГйуГ╝:', error);
      }
    };
    loadCustomExercises();
  }, [getCustomExercises]);

  // хЕичиочЫоуГкуВ╣уГИя╝ИхЫ║хоЪ + уВлуВ╣уВ┐уГая╝Й
  const allExercises = [...EXERCISE_LIST, ...customExercises];

  // уГЗуГРуГГуВ░цГЕха▒
  console.log('RecordTab rendered with:', {
    todayRecords: todayRecords.length,
    allRecords: allRecords.length,
    firstRecord: allRecords[0],
    customExercises: customExercises.length
  });
  // ф╗КцЧеуБоч╡▒шиИуВТшиИчоЧ
  const todayStats = todayRecords.reduce((stats, record) => {
    record.exercises.forEach(exercise => {
      stats.totalReps += exercise.reps || 0;
      stats.totalSets += exercise.sets || 0;
      stats.exerciseCount += 1;
    });
    return stats;
  }, {
    totalReps: 0,
    totalSets: 0,
    exerciseCount: 0
  });

  // ч╢Щч╢ЪцЧецХ░уВТшиИчоЧ
  const calculateStreaks = (records) => {
    if (records.length === 0) return { currentStreak: 0, maxStreak: 0 };
    
    // цЧеф╗ШхИеуБлуВ░уГлуГ╝уГЧхМЦ
    const dateGroups = {};
    records.forEach(record => {
      const dateStr = new Date(record.timestamp).toDateString();
      dateGroups[dateStr] = true;
    });
    
    const workoutDates = Object.keys(dateGroups)
      .map(dateStr => new Date(dateStr))
      .sort((a, b) => b - a); // цЦ░уБЧуБДцЧеф╗ШщаЖ
    
    if (workoutDates.length === 0) return { currentStreak: 0, maxStreak: 0 };
    
    // чП╛хЬиуБоч╢Щч╢ЪцЧецХ░уВТшиИчоЧ
    let currentStreak = 0;
    const today = new Date().toDateString();
    const yesterday = new Date();
    yesterday.setDate(yesterday.getDate() - 1);
    
    // ф╗КцЧеуБ╛уБЯуБпцШицЧеуБЛуВЙщАгч╢ЪуБЧуБжуБДуВЛцЧецХ░уВТцХ░уБИуВЛ
    let checkDate = new Date();
    if (workoutDates[0].toDateString() !== today) {
      checkDate.setDate(checkDate.getDate() - 1);
    }
    
    while (checkDate >= workoutDates[workoutDates.length - 1]) {
      const checkDateStr = checkDate.toDateString();
      if (dateGroups[checkDateStr]) {
        currentStreak++;
      } else if (currentStreak > 0) {
        break;
      }
      checkDate.setDate(checkDate.getDate() - 1);
    }
    
    // цЬАхдзч╢Щч╢ЪцЧецХ░уВТшиИчоЧ
    let maxStreak = 0;
    let tempStreak = 1;
    
    for (let i = 1; i < workoutDates.length; i++) {
      const currentDate = workoutDates[i];
      const prevDate = workoutDates[i - 1];
      const dayDiff = Math.floor((prevDate - currentDate) / (1000 * 60 * 60 * 24));
      
      if (dayDiff === 1) {
        tempStreak++;
      } else {
        maxStreak = Math.max(maxStreak, tempStreak);
        tempStreak = 1;
      }
    }
    maxStreak = Math.max(maxStreak, tempStreak);
    
    return { currentStreak, maxStreak };
  };

  const { currentStreak, maxStreak } = calculateStreaks(allRecords);

  // ч╖ищЫЖуГвуГ╝уГЙуБощЦЛхзЛ
  const startEditing = (exerciseId, currentReps, currentSets) => {
    setEditingExercise(exerciseId);
    setEditValues({ reps: currentReps.toString(), sets: currentSets.toString() });
  };

  // ч╖ищЫЖуБоуВнуГгуГ│уВ╗уГл
  const cancelEditing = () => {
    setEditingExercise(null);
    setEditValues({ reps: '', sets: '' });
  };

  // ч╖ищЫЖхЖЕхо╣уБоф┐ЭхнШ
  const saveEdit = async (exerciseId) => {
    const exercise = allExercises.find(ex => ex.id === exerciseId);
    if (!exercise || !editValues.reps || !editValues.sets) {
      alert('хЫЮцХ░уБиуВ╗уГГуГИцХ░уВТхЕехКЫуБЧуБжуБПуБауБХуБД');
      return;
    }

    setIsLoading(true);
    try {
      const record = {
        id: Date.now().toString(),
        timestamp: new Date(),
        raw_input: `${exercise.name} ${editValues.reps}хЫЮ ${editValues.sets}уВ╗уГГуГИ`,
        exercises: [{
          name: exercise.name,
          weight: exercise.defaultWeight,
          reps: parseInt(editValues.reps),
          sets: parseInt(editValues.sets),
          volume: parseInt(editValues.reps) * parseInt(editValues.sets)
        }]
      };

      await saveRecord(record);
      onRecordSaved(record);
      
      // ч╖ищЫЖуГвуГ╝уГЙуВТч╡Вф║Ж
      cancelEditing();
      
    } catch (error) {
      console.error('шиШщМ▓ф┐ЭхнШуВиуГйуГ╝:', error);
      alert('шиШщМ▓уБоф┐ЭхнШуБлхд▒цХЧуБЧуБ╛уБЧуБЯуАВ');
    } finally {
      setIsLoading(false);
    }
  };

  // цЦ░шжПшиШщМ▓уБош┐╜хКая╝ИцЬкхоЯцЦ╜уБочиочЫочФия╝Й
  const addNewRecord = async (exerciseId) => {
    const exercise = allExercises.find(ex => ex.id === exerciseId);
    if (!exercise) return;
    
    // ч╖ищЫЖуГвуГ╝уГЙуВТщЦЛхзЛя╝ИуГЗуГХуВйуГлуГИхАдуБзя╝Й
    setEditingExercise(exerciseId);
    setEditValues({ reps: '10', sets: '1' });
  };

  // уВлуВ╣уВ┐уГачиочЫош┐╜хКа
  const handleAddCustomExercise = async () => {
    if (!newExerciseName.trim()) {
      alert('чиочЫохРНуВТхЕехКЫуБЧуБжуБПуБауБХуБД');
      return;
    }

    setIsLoading(true);
    try {
      const customExercise = await addCustomExercise(newExerciseName.trim());
      await saveCustomExercise(customExercise);
      
      // уГкуВ╣уГИуВТцЫ┤цЦ░
      setCustomExercises(prev => [...prev, customExercise]);
      
      // UIуВТуГкуВ╗уГГуГИ
      setNewExerciseName('');
      setShowAddExercise(false);
      
      alert(`уАМ${customExercise.name}уАНуВТш┐╜хКауБЧуБ╛уБЧуБЯя╝Б`);
      
    } catch (error) {
      console.error('уВлуВ╣уВ┐уГачиочЫош┐╜хКауВиуГйуГ╝:', error);
      alert('чиочЫоуБош┐╜хКауБлхд▒цХЧуБЧуБ╛уБЧуБЯ');
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <div className="record-tab">
      {/* уГбуВдуГ│уБошиШщМ▓уВиуГкуВв */}
      <div className="main-record-area">
        <h2>уГИуГмуГ╝уГЛуГ│уВ░уВТшиШщМ▓</h2>
        
        {/* хЕехКЫцЦ╣ц│ХщБ╕цКЮ */}
        <div className="input-mode-selector">
          <button 
            className={`mode-btn ${inputMode === 'voice' ? 'active' : ''}`}
            onClick={() => setInputMode('voice')}
          >
            ЁЯОд щЯ│хг░уБзшй▒уБЩ
          </button>
          <button 
            className={`mode-btn ${inputMode === 'manual' ? 'active' : ''}`}
            onClick={() => setInputMode('manual')}
          >
            ЁЯУЭ чиочЫоуВТщБ╕уБ╢
          </button>
        </div>

        {/* щЯ│хг░хЕехКЫуГвуГ╝уГЙ */}
        {inputMode === 'voice' && (
          <div className="voice-input-section">
            <p className="record-hint">
              ЁЯТм ф╛Л: уАМшЕХчлЛуБжф╝ПуБЫ20хЫЮ3уВ╗уГГуГИуАНуАМцЗ╕хЮВ10хЫЮ2уВ╗уГГуГИуАНуАМцШицЧеуВ╣уВпуГпуГГуГИ30хЫЮуАН
            </p>
            
            <VoiceRecorder 
              onRecordSaved={onRecordSaved} 
              isLoading={isLoading}
              setIsLoading={setIsLoading}
            />

          </div>
        )}

        {/* цЙЛхЛХхЕехКЫуГвуГ╝уГЙя╝Иф╗КцЧеуБошиШщМ▓уВлуГ╝уГЙуБзчЫ┤цОеч╖ищЫЖя╝Й */}
        {inputMode === 'manual' && (
          <div className="manual-input-section">
            <p className="record-hint">
              ЁЯУЛ ф╕ЛуБошиШщМ▓уВлуГ╝уГЙуВТуВпуГкуГГуВпуБЧуБжчЫ┤цОеч╖ищЫЖуБЧуБжуБПуБауБХуБД
            </p>
          </div>
        )}
      </div>

      {/* ч╢Щч╢ЪчОЗуВлуГ╝уГЙ */}
      {(todayRecords.length > 0 || allRecords.length > 0) && (
        <div className="streak-card">
          <div className="streak-header">
            <div className="streak-icon">ЁЯФе</div>
            <h3 className="streak-title">ч╢Щч╢ЪхКЫ</h3>
            <p className="streak-subtitle">цпОцЧеуБочйНуБ┐щЗНуБн</p>
          </div>
          <div className="streak-stats">
            <div className="streak-item primary">
              <div className="streak-value">{currentStreak}</div>
              <div className="streak-unit">цЧе</div>
              <div className="streak-label">чП╛хЬи</div>
            </div>
            <div className="streak-divider"></div>
            <div className="streak-item secondary">
              <div className="streak-value">{maxStreak}</div>
              <div className="streak-unit">цЧе</div>
              <div className="streak-label">цЬАщлШ</div>
            </div>
          </div>
          <div className="streak-progress-bar">
            <div 
              className="streak-progress-fill" 
              style={{ width: `${maxStreak > 0 ? (currentStreak / maxStreak) * 100 : 0}%` }}
            ></div>
          </div>
        </div>
      )}

      {/* ф╗КцЧеуБоуГИуГмуГ╝уГЛуГ│уВ░шиШщМ▓ */}
      <div className="today-exercises">
        <div className="today-exercises-header">
          <h3>ф╗КцЧеуБоуГИуГмуГ╝уГЛуГ│уВ░шиШщМ▓ ЁЯУК</h3>
          <button 
            className="add-exercise-btn"
            onClick={() => setShowAddExercise(true)}
            disabled={isLoading}
          >
            тЮХ чиочЫош┐╜хКа
          </button>
        </div>
        
        {/* уВлуВ╣уВ┐уГачиочЫош┐╜хКаUI */}
        {showAddExercise && (
          <div className="add-exercise-form">
            <div className="add-exercise-inputs">
              <input
                type="text"
                value={newExerciseName}
                onChange={(e) => setNewExerciseName(e.target.value)}
                placeholder="цЦ░уБЧуБДчиочЫохРНуВТхЕехКЫ"
                className="exercise-name-input"
                onKeyDown={(e) => e.key === 'Enter' && handleAddCustomExercise()}
              />
              <button 
                onClick={handleAddCustomExercise}
                disabled={isLoading || !newExerciseName.trim()}
                className="save-exercise-btn"
              >
                {isLoading ? 'хИЖцЮРф╕н...' : 'ш┐╜хКа'}
              </button>
              <button 
                onClick={() => {
                  setShowAddExercise(false);
                  setNewExerciseName('');
                }}
                className="cancel-exercise-btn"
              >
                уВнуГгуГ│уВ╗уГл
              </button>
            </div>
            <p className="add-exercise-hint">
              ЁЯТб AIуБМшЗкхЛХуБзщГиф╜НуБич╡╡цЦЗхнЧуВТхИдхоЪуБЧуБ╛уБЩ
            </p>
          </div>
        )}

        <div className="today-exercise-grid">
          {allExercises.map(exercise => {
            // ф╗КцЧеуБоуБУуБочиочЫоуБошиШщМ▓уВТщЫЖшиИ
            const todayStats = todayRecords.reduce((stats, record) => {
              record.exercises.forEach(ex => {
                if (ex.name === exercise.name) {
                  stats.totalReps += ex.reps || 0;
                  stats.totalSets += ex.sets || 0;
                  stats.sessions += 1;
                }
              });
              return stats;
            }, { totalReps: 0, totalSets: 0, sessions: 0 });

            const hasData = todayStats.totalReps > 0;

            return (
              <div 
                key={exercise.id} 
                className={`today-exercise-card ${hasData ? 'completed' : 'not-completed'} ${inputMode === 'manual' ? 'editable' : ''}`}
                onClick={() => inputMode === 'manual' && (hasData ? startEditing(exercise.id, todayStats.totalReps, todayStats.totalSets) : addNewRecord(exercise.id))}
              >
                <div className="today-exercise-header">
                  <span className="today-exercise-icon">{exercise.icon}</span>
                  <span className="today-exercise-name">{exercise.name}</span>
                </div>
                <div className="today-exercise-stats">
                  {editingExercise === exercise.id ? (
                    <div className="edit-form">
                      <div className="edit-input-group">
                        <input
                          type="number"
                          value={editValues.reps}
                          onChange={(e) => setEditValues({...editValues, reps: e.target.value})}
                          placeholder="хЫЮцХ░"
                          className="edit-input"
                          min="1"
                        />
                        <span className="edit-unit">{exercise.unit}</span>
                      </div>
                      <div className="edit-input-group">
                        <input
                          type="number"
                          value={editValues.sets}
                          onChange={(e) => setEditValues({...editValues, sets: e.target.value})}
                          placeholder="уВ╗уГГуГИ"
                          className="edit-input"
                          min="1"
                        />
                        <span className="edit-unit">уВ╗уГГуГИ</span>
                      </div>
                      <div className="edit-actions">
                        <button className="save-btn" onClick={(e) => { e.stopPropagation(); saveEdit(exercise.id); }}>
                          тЬУ
                        </button>
                        <button className="cancel-btn" onClick={(e) => { e.stopPropagation(); cancelEditing(); }}>
                          тЬХ
                        </button>
                      </div>
                    </div>
                  ) : (
                    <>
                      {hasData ? (
                        <>
                          <div className="stat-item">
                            <span className="stat-value">{todayStats.totalReps}</span>
                            <span className="stat-unit">{exercise.unit}</span>
                          </div>
                          <div className="stat-item">
                            <span className="stat-value">{todayStats.totalSets}</span>
                            <span className="stat-unit">уВ╗уГГуГИ</span>
                          </div>
                        </>
                      ) : (
                        <span className="no-data">{inputMode === 'manual' ? 'уВ┐уГГуГЧуБЧуБжшиШщМ▓' : 'цЬкхоЯцЦ╜'}</span>
                      )}
                      {inputMode === 'manual' && (
                        <div className="edit-hint">тЬПя╕П</div>
                      )}
                    </>
                  )}
                </div>
              </div>
            );
          })}
        </div>
      </div>

      {/* хИЭхЫЮхИйчФицЩВуБоуВжуВзуГлуВлуГауГбуГГуВ╗уГ╝уВ╕ */}
      {todayRecords.length === 0 && (
        <div className="welcome-message">
          <div className="welcome-icon">ЁЯТк</div>
          <h3>WorkoutVoiceуБ╕уВИуБЖуБУуБЭя╝Б</h3>
          <p>2уБдуБоцЦ╣ц│ХуБзуГИуГмуГ╝уГЛуГ│уВ░уВТшиШщМ▓уБзуБНуБ╛уБЩ</p>
          <div className="welcome-tips">
            <div className="tip">ЁЯОд <strong>щЯ│хг░уБзшй▒уБЩ</strong>я╝ЪуАМшЕХчлЛуБжф╝ПуБЫ20хЫЮ3уВ╗уГГуГИуАНуБишй▒уБЩуБауБС</div>
            <div className="tip">ЁЯУЭ <strong>чиочЫоуВТщБ╕уБ╢</strong>я╝ЪуГЬуВ┐уГ│уБЛуВЙчиочЫоуВТщБ╕уВУуБзцХ░хАдхЕехКЫ</div>
            <div className="tip">ЁЯУК уБйуБбуВЙуВВхРМуБШуВИуБЖуБлч╡▒шиИуБМф╜ЬцИРуБХуВМуБ╛уБЩ</div>
          </div>
        </div>
      )}
    </div>
  );
};

export default RecordTab;